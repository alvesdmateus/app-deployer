apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: app-deployer-prod

namespace: app-deployer

resources:
  - ../../base
  - hpa.yaml
  - pdb.yaml

labels:
  - includeSelectors: true
    pairs:
      environment: production

patches:
  # Production replicas
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: app-deployer-api
      spec:
        replicas: 3
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: app-deployer-worker
      spec:
        replicas: 3
  # Production resource limits
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: app-deployer-api
      spec:
        template:
          spec:
            containers:
              - name: api
                resources:
                  requests:
                    cpu: 200m
                    memory: 512Mi
                  limits:
                    cpu: 1000m
                    memory: 1Gi
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: app-deployer-worker
      spec:
        template:
          spec:
            containers:
              - name: worker
                resources:
                  requests:
                    cpu: 500m
                    memory: 1Gi
                  limits:
                    cpu: 2000m
                    memory: 2Gi

configMapGenerator:
  - name: app-deployer-config
    behavior: merge
    literals:
      - |
        config.yaml=
        server:
          log_level: info
        tracing:
          enabled: true
          environment: production
          sample_rate: 0.1

images:
  - name: app-deployer
    newName: gcr.io/YOUR_PROJECT/app-deployer
    newTag: v1.0.0
